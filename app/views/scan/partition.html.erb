<head>
<title>EbyDict: Partitioner</title>
<script>
var colnum = 0;
var theseps = '';
var seps = [];
var canvas;
var context;
var imageObj;
var line;
function cancel_seps()
{
  $('#col_seps').html("");
  theseps = '';
  $('#final_seps').attr('value','');
  colnum = 0;
  seps = [];
  context.drawImage(imageObj,0,0); 
}

function markColumn(e) {
  var offset = $(this).offset();
  colnum++;
  var relx = e.pageX- offset.left;
  $('#col_seps').html($('#col_seps').html()+"col #"+colnum+": "+relx+" | ");
  if(theseps !== '')
    theseps += '|';
  theseps += relx;
  $('#final_seps').attr('value', theseps);
  seps.push(relx);
  drawSeps();
}

function drawSeps() {
  for(var i=0; i < seps.length; i++) {
    context.beginPath();
    context.moveTo(seps[i], 0);
    context.lineTo(seps[i], $('#myCanvas').height());
    context.stroke();
  }
}

//------------------------------------------------
function Line(ctx) {
    
    var me = this;
    
    this.x1 = 0;
    this.x2 = 0;
    this.y1 = 0;
    this.y2 = 0;
    
    this.draw = function() {
        oldstyle = ctx.strokeStyle;
        ctx.strokeStyle = '#a8a';
        ctx.beginPath();
        ctx.moveTo(me.x1, me.y1);
        ctx.lineTo(me.x2, me.y2);
        ctx.stroke();
        ctx.strokeStyle = oldstyle;
    }
}

function updateLine(e) {
    var r = canvas.getBoundingClientRect(),
        x = e.clientX - r.left,
        y = e.clientY - r.top;
    
    context.drawImage(imageObj, 0, 0, canvas.width, canvas.height);
    line.x1 = x;
    line.y1 = 0;
    line.x2 = x;
    line.y2 = canvas.height;
    line.draw();
    drawSeps();
}
//------------------------------------------------

// Bog bless jQuery!
$(document).ready(function() {

  canvas = document.getElementById("myCanvas");
  context = canvas.getContext("2d");
  imageObj = new Image();

  imageObj.onload = function() { 
    context.drawImage(imageObj, 0,0);  
  }
  imageObj.src = "<%= @smallimg %>";
  $('#myCanvas').click(markColumn);
  line = new Line(context);
  canvas.onmousemove = updateLine;
});
</script>

</head>

<body> <b>Partitioning scan: <%= @origimg %></b>
<%= form_tag '/scan/dopartition/'+@sc.id.to_s %> <div id="part_tools"><%= submit_tag "Save Partitions and Get Another Image", :name => 'save_and_next' %> || <%= submit_tag "Save Partitions", :name => 'commit' %> || <%= submit_tag "Don't Save; Abandon this Image", :name => 'abandon' %> <a href="" onclick="cancel_seps()">Cancel and Start Over</a> <p/>
<span style="color:green">Please enter the Page Numbers in this image (Examples: <b>3</b> or <b>4-5</b>):</span><input name="pagenos" size="10" value="<%= @prefilled_pagenums %>"/>
<a href="<%= @origimg %>" target="_new">Click to see original (large) image in new window</a><br/>
Column separators marked so far: <span id="col_seps"></span>
<input type="hidden" name="seps" id="final_seps"/>
</form> 
</div>
Small Image: <div id="smallimg_container" style="position:relative"><canvas id="myCanvas" width="<%= @width + 1 %>" height="<%= @height + 1 %>"></canvas></div>
<p/>
</body>
